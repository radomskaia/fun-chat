var ee=Object.defineProperty;var te=(i,e,t)=>e in i?ee(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var r=(i,e,t)=>te(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const g of o.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&s(g)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const se="_container_1vmo5_1",ie="_flex_1vmo5_7",ne="_flexColumn_1vmo5_11",re="_alignCenter_1vmo5_15",ae="_center_1vmo5_19",oe="_justifyBetween_1vmo5_28",ce="_gap30_1vmo5_37",le="_gap20_1vmo5_41",de="_gap10_1vmo5_45",he="_widthFull_1vmo5_58",ue="_flexGrow1_1vmo5_62",ge="_marginInline10_1vmo5_88",me="_capitalize_1vmo5_92",Ee="_alignSelfStart_1vmo5_96",pe="_alignSelfEnd_1vmo5_101",a={container:se,flex:ie,flexColumn:ne,alignCenter:re,center:ae,justifyBetween:oe,gap30:ce,gap20:le,gap10:de,widthFull:he,flexGrow1:ue,marginInline10:ge,capitalize:me,alignSelfStart:Ee,alignSelfEnd:pe},Se="_headerPrimary_1tw7k_1",fe="_header_1tw7k_1",q={headerPrimary:Se,header:fe},j={BACK:"back",THEME:"theme"},ve={THEME:"Change theme"},I={NAMESPACE_SVG:"http://www.w3.org/2000/svg",NAMESPACE_XLINK:"http://www.w3.org/1999/xlink",QUALIFIED_NAME:"xlink:href",ROLE:"img"},K="./sprite.svg#",X={THEME:{ON:K+"theme-light",OFF:K+"theme-dark"}},Ie="Fun Chat",ye="radomskaia--fun-chat--",B=0,C=1,M="",De={HASH:"#"},m={MAIN:"/",LOGIN:"/login",ABOUT:"/about",NOT_FOUND:"404"},N={ROUTE_NOT_FOUND:"Route not found",NOT_INITIALIZED:"Class is not initialized",PAGE_NOT_FOUND:"Sorry, page not found"},A={PATH_REQUIRED:"Path is required",NO_LISTENERS:"No listeners for event type",SERVICE_NOT_FOUND:"Service not found",INVALID_SERVICE:"Invalid service",CONTAINER_NOT_FOUND:"Container not found"},Oe={ARIA_LABEL:"aria-label"},Q=300,v=class v{constructor(){r(this,"services");r(this,"factory");this.services=new Map,this.factory=new Map}static getInstance(){return v.instance||(v.instance=new v),v.instance}static isServiceType(e,t){return t.name===e}register(e,t){this.factory.set(e,t)}getService(e){let t=this.services.get(e);if(!t){const s=this.factory.get(e);if(!s)throw new Error(`${A.SERVICE_NOT_FOUND} ${e}`);t=new s,this.services.set(e,t)}if(!v.isServiceType(e,t))throw new Error(`${A.INVALID_SERVICE} ${e}`);return t}};r(v,"instance");let d=v;var c=(i=>(i.ROUTER="router",i.EVENT_EMITTER="eventEmitter",i.STORAGE="sessionStorage",i.VALIDATOR="validator",i.WEBSOCKET="WebSocketService",i.USER_SERVICE="LoginService",i.MESSAGE_SERVICE="MessageService",i))(c||{});class E{constructor(e){r(this,"element");r(this,"listeners",new Map);r(this,"createDOMElement",({tagName:e,classList:t,textContent:s,attributes:n})=>{const o=document.createElement(e);return t&&this.addClassList(t,o),n&&this.addAttributes(n,o),s&&this.addTextContent(s,o),o});r(this,"addClassList",(e,t)=>{t=t??this.element,t.classList.add(...e)});r(this,"addAttributes",(e,t)=>{t=t??this.element;for(const[s,n]of Object.entries(e))t.setAttribute(s,n)});r(this,"addTextContent",(e,t)=>{t=t??this.element,t.textContent=e});r(this,"createSVG",({path:e,classList:t,attributes:s})=>{const n=document.createElementNS(I.NAMESPACE_SVG,"svg");this.addAttributes({...s,role:I.ROLE},n),this.addClassList(t,n);const o=document.createElementNS(I.NAMESPACE_SVG,"use");return o.setAttributeNS(I.NAMESPACE_XLINK,I.QUALIFIED_NAME,e),n.append(o),{use:o,svg:n}});this.element=this.createElement(e)}registerEvent(e,t){this.listeners.has(e)||this.listeners.set(e,[]);const s=this.listeners.get(e);s==null||s.push(t),d.getInstance().getService(c.EVENT_EMITTER).subscribe(e,this)}update(e){const t=this.listeners.get(e.type);if(!t){console.info(A.NO_LISTENERS);return}for(const s of t)s(e.data)}getElement(){return this.element}appendElement(...e){this.element.append(...e)}clearElement(){this.element.replaceChildren()}}const be="_button_31epl_1",we="_actionButton_31epl_11",Me="_iconButton_31epl_32",Le="_settings_31epl_41",P={button:be,actionButton:we,iconButton:Me,settings:Le};class Z extends E{constructor(e){super(),e&&this.addListener(e)}toggleDisabled(){this.disabledElement(!this.element.disabled)}disabledElement(e){this.element.disabled=e}addListener(e){this.element.addEventListener("click",e)}createElement(){return this.createDOMElement({tagName:"button",classList:[P.button]})}}class _e extends Z{constructor(t,s){super(s);r(this,"useSVGIcon");this.element.title=t.title;const{use:n,svg:o}=this.createSVG({path:t.path,classList:[P.iconButton,...t.classList],attributes:{title:t.title,[Oe.ARIA_LABEL]:t.title}});this.useSVGIcon=n,this.appendElement(o)}}class Ae extends _e{constructor(e){if(!e.path)throw new Error(A.PATH_REQUIRED);super({title:e.title,classList:e.classList??[],path:e.path}),this.addClassList([P.settings])}togglePath(e){const t=e?this.pathOff:this.pathOn;this.useSVGIcon.setAttributeNS(I.NAMESPACE_XLINK,I.QUALIFIED_NAME,t)}addToggleListener(e){this.addListener(()=>{e.toggle()})}}class Te extends Ae{constructor(){const t=X.THEME.ON,s=ve.THEME;super({path:t,title:s});r(this,"pathOn");r(this,"pathOff",X.THEME.OFF);r(this,"title");this.title=s,this.pathOn=t}}class Re{constructor(e){this.button=e,this.button=e}}const Ce="(prefers-color-scheme: dark)",Ne="data-theme",y=class y extends Re{constructor(t){super(t);r(this,"isOff");r(this,"mediaQueryList");this.mediaQueryList=globalThis.matchMedia(Ce),this.isOff=this.mediaQueryList.matches,this.changeTheme(this.isOff),this.mediaQueryList.addEventListener("change",s=>{this.changeTheme(s.matches)})}static getInstance(t){if(!y.instance){if(!t)throw new Error(N.NOT_INITIALIZED);y.instance=new y(t)}return y.instance}toggle(){this.isOff=!this.isOff,this.changeTheme(this.isOff)}changeTheme(t){this.button.togglePath(t),document.body.toggleAttribute(Ne,t)}};r(y,"instance");let H=y;class _ extends Z{constructor(e,t){super(t),this.element.textContent=e,this.addClassList([P.actionButton])}}class xe extends E{constructor(){super();r(this,"settingsButton",{theme:{button:Te,action:H}});r(this,"settingsWrapper");this.settingsWrapper=this.createSettingsWrapper(),this.appendElement(this.settingsWrapper)}addSettingsButton(t){const s=new this.settingsButton[t].button,n=this.settingsButton[t].action.getInstance(s);return s.addToggleListener(n),this.settingsWrapper.append(s.getElement()),this}createElement(){const t=this.createDOMElement({tagName:"header",classList:[q.header,a.container,a.flex,a.alignCenter,a.justifyBetween,a.widthFull]}),s=this.createDOMElement({tagName:"h1",textContent:Ie,classList:[q.headerPrimary]}),n=new _("About",()=>{d.getInstance().getService(c.ROUTER).navigateTo(m.ABOUT)}).getElement();return t.append(s,n),t}createSettingsWrapper(){return this.createDOMElement({tagName:"div",classList:[a.flex,a.center,a.gap30,a.marginInline10]})}}class Ue extends E{constructor(){super();r(this,"homeButton");this.homeButton=new _(j.BACK,()=>d.getInstance().getService(c.ROUTER).navigateTo(m.LOGIN)),this.appendElement(this.homeButton.getElement())}createElement(){const t=this.createDOMElement({tagName:"div",classList:[a.flex,a.container,a.flexColumn,a.center,a.gap30]}),s=this.createDOMElement({tagName:"p",textContent:N.PAGE_NOT_FOUND});return t.append(s),t}}const Ge="_input_qaekf_1",Be={input:Ge};class k extends E{constructor(){super(...arguments);r(this,"defaultValue",M)}get value(){return this.element.value}set value(t){this.element.value=t}setDefaultValue(){this.defaultValue=this.element.value}resetValue(){this.element.value=this.defaultValue}toggleDisabled(){this.element.disabled=!this.element.disabled}createElement(t){const s=this.createDOMElement({tagName:"input",classList:[Be.input]});return t.label&&(s.name=t.label),s.placeholder=t.placeholder,s}}class Pe extends k{constructor(){super({label:"name",placeholder:"Enter your name"}),this.element.required=!0,this.element.type="text",this.element.pattern="[a-zA-Z0-9_]{4,10}",this.element.title="Use 4–10 characters with no spaces. Only letters (a–z, A–Z), numbers (0–9), and underscores (_) are allowed",this.element.autocomplete="username",this.element.autofocus=!0}}class ke extends k{constructor(){super({label:"password",placeholder:"Enter your password"}),this.element.required=!0,this.element.type="password",this.element.pattern=String.raw`(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}`,this.element.title="Use at least 8 characters with no spaces and include at least one uppercase letter, one lowercase letter and one number",this.element.autocomplete="current-password"}}class Ve extends E{constructor(t){super(t);r(this,"inputConfig",{username:Pe,password:ke});this.addInputs();const s=new _("Submit");s.getElement().type="submit",this.appendElement(s.getElement())}getFormData(){const t=new FormData(this.element),s=t.get("name"),n=t.get("password");return{login:s,password:n}}createElement(t){const s=this.createDOMElement({tagName:"form"});return this.addClassList([a.flex,a.flexColumn,a.gap10,a.alignCenter],s),s.addEventListener("submit",n=>t(n)),s}addInputs(){for(const[t,s]of Object.entries(this.inputConfig)){const n=this.createDOMElement({tagName:"label",textContent:`${t}: `,classList:[a.flex,a.gap10,a.alignCenter,a.capitalize]}),o=new s;n.append(o.getElement()),this.appendElement(n)}}}class Fe extends E{constructor(t){super();r(this,"form");this.form=new Ve(t),this.appendElement(this.form.getElement())}getFormData(){return this.form.getFormData()}createElement(){return this.createDOMElement({tagName:"div"})}}var l=(i=>(i.object="object",i.string="string",i.number="number",i.boolean="boolean",i.authData="authData",i.usersPayload="usersPayload",i.userPayload="userPayload",i.message="message",i.messagePayload="messagePayload",i.messagesPayload="messagesPayload",i.isReadedStatusPayload="isReadedStatusPayload",i.isDeliveredStatusPayload="isDeliveredStatusPayload",i.isEditedStatusPayload="isEditedStatusPayload",i.isDeletedStatusPayload="isDeletedStatusPayload",i))(l||{});class He{constructor(){r(this,"view");r(this,"userService",d.getInstance().getService(c.USER_SERVICE));this.view=new Fe(e=>this.formHandler(e))}getElement(){return this.view.getElement()}formHandler(e){e.preventDefault();const t=this.view.getFormData();d.getInstance().getService(c.VALIDATOR).validate(l.authData,t)&&this.userService.login(t)}}class je extends k{constructor(){super({placeholder:"Search"}),this.element.type="search"}}var p=(i=>(i.USER="user",i))(p||{});class We{constructor(e,t){r(this,"state");r(this,"reducer");r(this,"listeners",[]);this.state=structuredClone(e),this.reducer=t}getState(){return structuredClone(this.state)}dispatch(e){this.state=this.reducer(this.state,e);for(const t of this.listeners)t(structuredClone(this.state),e)}subscribe(e){return this.listeners.push(e),()=>this.listeners=this.listeners.filter(t=>t!==e)}}class qe{constructor(e){r(this,"observers",new Map);e.subscribe((t,s)=>{s&&this.notify(t,s)})}subscribe(e,t){const s=this.observers.get(t);return s?s.push(e):this.observers.set(t,[e]),t==="dialogId"&&console.log("subscribe",t,this.observers),()=>{var o;const n=(o=this.observers.get(t))==null?void 0:o.filter(g=>e!==g);n&&this.observers.set(t,n)}}notify(e,t){const s=this.observers.get(t.type);if(s)for(const n of s)n(e,t)}}class W{constructor(e,t){r(this,"store");r(this,"observer");this.store=new We(e,t),this.observer=new qe(this.store)}getState(e){const t=this.store.getState();return e?t[e]:t}subscribe(e,t){let s;return s=t?this.observer.subscribe(e,t):this.store.subscribe(e),s}dispatch(e){this.store.dispatch(e)}}function Ke(i,e){return{...i,[e.type]:e.payload}}const D=class D extends W{constructor(t,s){super(t,s);r(this,"storageService",d.getInstance().getService(c.STORAGE));window.addEventListener("beforeunload",()=>{const n=this.store.getState().user;n?this.storageService.save(p.USER,n):this.storageService.remove(p.USER)})}static getInstance(){if(!D.instance){const t=d.getInstance().getService(c.STORAGE).load(p.USER,l.authData),s={[p.USER]:t};D.instance=new D(s,Ke)}return D.instance}};r(D,"instance");let L=D;const Xe="_user_1y512_1",$e={user:Xe};class ze extends E{constructor(t){super(t);r(this,"counter",null)}addCounter(t){this.counter?this.counter.textContent=t.toString():(this.counter=this.createDOMElement({tagName:"strong",textContent:t.toString()}),this.element.append(this.counter))}removeCounter(){this.counter&&(this.counter.remove(),this.counter=null)}createElement(t){return this.createDOMElement({tagName:"li",classList:[a.flex,a.gap10,$e.user],textContent:t})}}function Qe(i,e){return{...i,[e.type]:e.payload}}const O=class O extends W{constructor(e,t){super(e,t)}static getInstance(){if(!O.instance){const e={};O.instance=new O(e,Qe)}return O.instance}};r(O,"instance");let x=O;var f=(i=>(i.DIALOG_ID="dialogId",i.MESSAGES="messages",i))(f||{}),h=(i=>(i.SET_DIALOG_ID="setDialogId",i.SET_MESSAGES="setMessages",i.ADD_MESSAGE="addMessage",i.DELETE_MESSAGE="deleteMessage",i.EDIT_MESSAGE="editMessage",i.DELIVER_MESSAGE="deliverMessage",i.READED_MESSAGE="readedMessage",i.CLEAR_DIALOG="clearDialog",i))(h||{});function Ze(i,e){switch(e.type){case h.SET_MESSAGES:{const t=new Map;for(const s of e.payload)t.set(s.id,s);return{...i,messages:t}}case h.SET_DIALOG_ID:return{...i,dialogId:e.payload};case h.ADD_MESSAGE:return i.messages.set(...e.payload),{...i,messages:i.messages};case h.DELETE_MESSAGE:return i.messages.delete(e.payload),{...i,messages:i.messages};case h.EDIT_MESSAGE:return V(i,e.payload,"isEdited");case h.DELIVER_MESSAGE:return V(i,e.payload,"isDelivered");case h.READED_MESSAGE:return V(i,e.payload,"isReaded");case h.CLEAR_DIALOG:return{...i,messages:new Map};default:return i}}function V(i,e,t){const s=i.messages,n=s.get(e.message.id),o=n==null?void 0:n.status;return o?(o[t]=e.message.status[t],t==="isEdited"&&"text"in e.message&&(n.text=e.message.text),{...i,[f.MESSAGES]:s}):i}const b=class b extends W{constructor(e,t){super(e,t)}static getInstance(){if(!b.instance){const e={[f.DIALOG_ID]:null,[f.MESSAGES]:new Map};b.instance=new b(e,Ze)}return b.instance}};r(b,"instance");let T=b;class Je{constructor(e){r(this,"view");this.view=new ze(e.login),x.getInstance().subscribe(t=>{const s=t[e.login];s===B?this.view.removeCounter():this.view.addCounter(s)},e.login),this.view.getElement().addEventListener("click",()=>{T.getInstance().dispatch({type:h.SET_DIALOG_ID,payload:e})})}getElement(){return this.view.getElement()}}class Ye extends E{constructor(){super();r(this,"messageService",d.getInstance().getService(c.MESSAGE_SERVICE))}addUsers(t){var o;const s=new Map,n=(o=L.getInstance().getState(p.USER))==null?void 0:o.login;for(const g of t){if(g.login===n)continue;const[S,Y]=this.addUser(g);this.messageService.setNewMessagesCount(S),s.set(S,Y)}return s}addUser(t){const s=new Je(t).getElement();return this.appendElement(s),[t.login,s]}createElement(){return this.createDOMElement({tagName:"ul"})}}class ${constructor(){r(this,"view");this.view=new Ye}getElement(){return this.view.getElement()}addUsers(e){return this.view.addUsers(e)}addUser(e){return this.view.addUser(e)}}class et extends E{constructor(t){super();r(this,"input");r(this,"lists",{online:new $,offline:new $});this.input=new je,this.input.getElement().addEventListener("input",t),this.element.append(this.input.getElement()),this.addDetails("online"),this.addDetails("offline")}addUsers(t,s){return this.lists[s].addUsers(t)}appendUserToList(t,s){this.lists[t].getElement().append(s)}addUser(t,s){return this.lists[s].addUser(t)}createElement(){return this.createDOMElement({tagName:"div",classList:[a.flex,a.gap20,a.flexColumn]})}addDetails(t){const s=this.createDOMElement({tagName:"details"}),n=this.createDOMElement({tagName:"summary",textContent:t,classList:[a.capitalize]});s.append(n,this.lists[t].getElement()),s.open=!0,this.appendElement(s)}}var u=(i=>(i.LOGIN="USER_LOGIN",i.LOGOUT="USER_LOGOUT",i.ACTIVE="USER_ACTIVE",i.INACTIVE="USER_INACTIVE",i.MESSAGE="MSG_SEND",i.HISTORY="MSG_FROM_USER",i.READ="MSG_READ",i.DELETE="MSG_DELETE",i.EDIT="MSG_EDIT",i.ERROR="ERROR",i.EXTERNAL_LOGIN="USER_EXTERNAL_LOGIN",i.EXTERNAL_LOGOUT="USER_EXTERNAL_LOGOUT",i.DELIVER="MSG_DELIVER",i))(u||{});function tt(i){if(i instanceof Error){console.warn(i.message);return}if(i instanceof Response){console.warn(i.statusText);return}if(i instanceof DOMException){console.info(i.message);return}console.warn(i)}function st(i,e=Q){let t;return function(...s){clearTimeout(t),t=setTimeout(()=>i(...s),e)}}class it{constructor(){r(this,"view");r(this,"users",{});r(this,"websocketService",d.getInstance().getService(c.WEBSOCKET));r(this,"validator",d.getInstance().getService(c.VALIDATOR));const e=st(this.inputHandler.bind(this),Q);this.view=new et(t=>{e(t)}),this.getUsers(u.ACTIVE),this.getUsers(u.INACTIVE),this.websocketService.requestFromServer(u.EXTERNAL_LOGIN,{action:t=>{this.validator.validate(l.userPayload,t)&&(this.addUser(t.user,"online"),d.getInstance().getService(c.MESSAGE_SERVICE).setNewMessagesCount(t.user.login))}}),this.websocketService.requestFromServer(u.EXTERNAL_LOGOUT,{action:t=>{this.validator.validate(l.userPayload,t)&&(this.addUser(t.user,"offline"),d.getInstance().getService(c.MESSAGE_SERVICE).setNewMessagesCount(t.user.login))}})}getElement(){return this.view.getElement()}inputHandler(e){if(!(e.target instanceof HTMLInputElement))return;const t=e.target.value.toLowerCase();let s={online:[...this.users.online.keys()].filter(n=>n.toLowerCase().includes(t)),offline:[...this.users.offline.keys()].filter(n=>n.includes(t))};for(const n of["online","offline"]){const o=this.users[n];for(const[g,S]of o.entries())if(s[n].includes(g)){if(S.isConnected)continue;this.view.appendUserToList(n,S)}else S.remove()}}addUser(e,t){for(const s of Object.keys(this.users)){if(s!==t){const g=this.users[s].get(e.login);g&&g.remove(),this.users[s].delete(e.login);continue}const[n,o]=this.view.addUser(e,s);this.users[s].set(n,o)}}getUsers(e){const t=e===u.ACTIVE?"online":"offline";this.websocketService.requestToServer(e,null,{error:s=>{console.error(s)},action:s=>{this.validator.validate(l.usersPayload,s)&&(this.users[t]=this.view.addUsers(s.users,t))}})}}const nt="_messageBlock_1yikg_1",rt="_messagesField_1yikg_11",at="_message_1yikg_1",F={messageBlock:nt,messagesField:rt,message:at};class ot extends k{constructor(){super({placeholder:"Your message..."}),this.element.required=!0,this.element.type="text",this.element.autofocus=!0,this.element.classList.add(a.widthFull)}}class ct extends E{constructor(t){super(t);r(this,"input");const s=new _("Send Message");s.getElement().type="submit",this.input=new ot,this.appendElement(this.input.getElement(),s.getElement())}getFormData(){const t=this.input.value;return this.input.resetValue(),t}createElement(t){const s=this.createDOMElement({tagName:"form"});return this.addClassList([a.flex,a.gap10,a.alignCenter],s),s.addEventListener("submit",n=>t(n)),s}}class lt extends E{constructor(){super();r(this,"user",null);r(this,"messageList",null);r(this,"messageForm",null);r(this,"statusElement",null);const t=d.getInstance().getService(c.WEBSOCKET),s=d.getInstance().getService(c.VALIDATOR);t.requestFromServer(u.EXTERNAL_LOGIN,{action:n=>{var o;s.validate(l.userPayload,n)&&n.user.login===((o=this.user)==null?void 0:o.login)&&this.changeStatus(n.user)}}),t.requestFromServer(u.EXTERNAL_LOGOUT,{action:n=>{var o;s.validate(l.userPayload,n)&&n.user.login===((o=this.user)==null?void 0:o.login)&&this.changeStatus(n.user)}})}createBlock(t,s){this.element.textContent=M,this.createNameRow(t),this.createMessageList(),this.createMessageInput(s)}clearBlock(){this.clearElement(),this.element.textContent="Select a user to send a message to..."}getFormData(){if(!this.messageForm)throw new Error("Message form is not initialized");return this.messageForm.getFormData()}addMessages(t){if(!(!this.messageList||t.length===B)){this.messageList.textContent=M;for(const s of t)this.addMessage(s)}}addMessage(t){var o;if(!this.messageList)return;this.messageList.textContent==="Write your first message..."&&(this.messageList.textContent=M);const s=t.from===((o=this.user)==null?void 0:o.login)?a.alignSelfStart:a.alignSelfEnd,n=this.createDOMElement({tagName:"li",textContent:t.text,classList:[s,F.message]});this.messageList.append(n)}scrollToBottom(){var t;(t=this.messageList)==null||t.scrollTo({top:this.messageList.scrollHeight,behavior:"smooth"})}createElement(){return this.createDOMElement({tagName:"div",classList:[F.messageBlock,a.flexColumn,a.gap10,a.flex],textContent:"Select a user to send a message to..."})}createNameRow(t){const s=this.createDOMElement({tagName:"div",classList:[a.flex,a.justifyBetween,a.alignCenter,a.widthFull]});this.user=t,this.element.append(s);const n=this.createDOMElement({tagName:"p",textContent:t.login}),o=this.createDOMElement({tagName:"p"});this.statusElement=o,this.changeStatus(t),s.append(n,o)}changeStatus(t){this.statusElement&&(this.statusElement.textContent=t.isLogined?"online":"offline")}createMessageList(){this.messageList=this.createDOMElement({tagName:"ul",textContent:"Write your first message...",classList:[a.flex,a.flexColumn,a.widthFull,a.gap10,a.flexGrow1,F.messagesField]}),this.element.append(this.messageList)}createMessageInput(t){this.messageForm=new ct(t),this.element.append(this.messageForm.getElement())}}class dt{constructor(){r(this,"view");r(this,"messageService",d.getInstance().getService(c.MESSAGE_SERVICE));r(this,"isRead",!1);this.view=new lt;const e=T.getInstance();e.subscribe(t=>{t.dialogId&&this.onOpenChat(t.dialogId)},h.SET_DIALOG_ID),e.subscribe((t,s)=>{if(!(s!=null&&s.payload)||s.type!==h.ADD_MESSAGE)return;const n=s.payload[C];this.view.addMessage(n),this.view.scrollToBottom(),this.isRead&&this.messageService.changeMessageStatus(n.id,"READ")},h.ADD_MESSAGE),this.view.getElement().addEventListener("click",()=>{if(this.isRead)return;const t=e.getState();for(const s of t[f.MESSAGES]){const n=s[C];t[f.DIALOG_ID]&&n.from===t[f.DIALOG_ID].login&&!n.status.isReaded&&this.messageService.changeMessageStatus(n.id,"READ")}})}getElement(){return this.view.getElement()}onOpenChat(e){this.isRead=!1,this.view.createBlock(e,t=>{t.preventDefault();const s=this.view.getFormData();this.messageService.sendMessage(s,e.login)}),this.messageService.getMessagesHistory(e.login,t=>{this.view.addMessages(t),this.view.scrollToBottom()})}}const ht="_footer_s5jvt_1",ut="_schoolLogo_s5jvt_6",z={footer:ht,schoolLogo:ut};class gt extends E{constructor(){super()}createElement(){const e=this.createDOMElement({tagName:"footer",classList:[z.footer,a.container,a.flex,a.alignCenter,a.justifyBetween,a.widthFull]}),t=this.createDOMElement({tagName:"img",classList:[z.schoolLogo]});t.src="./logo-rsschool.png";const s=this.createDOMElement({tagName:"a",textContent:"radomskaia",attributes:{href:"https://github.com/radomskaia",target:"_blank"}}),n=this.createDOMElement({tagName:"p",textContent:"2025"});return e.append(t,s,n),e}}const mt="_mainBlock_15fuo_1",Et={mainBlock:mt};class pt extends E{constructor(t,s){super();r(this,"mainWrapper",null);this.addHeader(t,s),this.createMainBlock();const n=new gt().getElement();this.element.append(n)}createMainBlock(){var n;(n=this.mainWrapper)==null||n.remove(),this.mainWrapper=this.createDOMElement({tagName:"div",classList:[a.flex,Et.mainBlock,a.gap20]});const t=new it,s=new dt().getElement();this.mainWrapper.append(t.getElement(),s),this.element.append(this.mainWrapper)}createElement(){return this.createDOMElement({tagName:"div",classList:[a.flex,a.container,a.flexColumn,a.gap30]})}addHeader(t,s){const n=this.createDOMElement({tagName:"div",classList:[a.flex,a.justifyBetween,a.alignCenter]}),o=this.createDOMElement({tagName:"p",textContent:`User: ${t}`}),g=new _("LogOut",s).getElement();n.append(o,g),this.element.append(n)}}var R=(i=>(i.changeRoute="changeRoute",i.openSocket="openSocket",i))(R||{});class St{constructor(){r(this,"view");r(this,"userService",d.getInstance().getService(c.USER_SERVICE));r(this,"store",L.getInstance());const e=this.store.getState(p.USER);if(!e)throw this.userService.logout(),new Error("User is not logged in");this.view=new pt(e.login,()=>this.userService.logout()),d.getInstance().getService(c.EVENT_EMITTER).subscribe(R.openSocket,this)}update(){var t;(t=this.store.getState(p.USER))!=null&&t.login&&this.view.createMainBlock()}getElement(){if(!this.view)throw new Error("View is not initialized");return this.view.getElement()}}class ft extends E{constructor(){super();r(this,"homeButton");this.homeButton=new _(j.BACK,()=>d.getInstance().getService(c.ROUTER).navigateTo(m.LOGIN)),this.appendElement(this.homeButton.getElement())}createElement(){const t=this.createDOMElement({tagName:"div",classList:[a.flex,a.container,a.flexColumn,a.center,a.gap30]}),s=this.createDOMElement({tagName:"p",textContent:"App development is part of the JavaScript/Front-end 2024Q4 course at Rolling Scopes School by Alena Radomskaia"});return t.append(s),t}}const vt=new Map([[m.LOGIN,He],[m.NOT_FOUND,Ue],[m.MAIN,St],[m.ABOUT,ft]]);class It{constructor(){r(this,"name",c.ROUTER);r(this,"routes",new Map);r(this,"container",null);r(this,"currentPath",M);r(this,"eventEmitter");globalThis.addEventListener("hashchange",()=>{this.routerChange()}),this.eventEmitter=d.getInstance().getService(c.EVENT_EMITTER)}setContainer(e){return this.container=e,this}addRoutes(e){this.routes=e,this.routerChange()}navigateTo(e){if(e===this.currentPath)return;this.clearPage();const t=L.getInstance().getState(p.USER);e===m.LOGIN&&t?e=m.MAIN:e===m.MAIN&&!t&&(e=m.LOGIN),this.currentPath=e;let s=this.routes.get(e)??this.routes.get(m.NOT_FOUND);if(!s)throw new Error(N.ROUTE_NOT_FOUND);if(globalThis.location.hash=e,!this.container)throw new Error(A.CONTAINER_NOT_FOUND);this.eventEmitter.notify({type:R.changeRoute,data:e}),this.container.append(new s().getElement())}clearPage(){if(!this.container)throw new Error(N.ROUTE_NOT_FOUND);this.container.replaceChildren()}routerChange(){const e=globalThis.location.hash.slice(De.HASH.length)||m.LOGIN;this.navigateTo(e)}}class yt{constructor(){r(this,"name",c.EVENT_EMITTER);r(this,"observers",new Map)}subscribe(e,t){this.observers.has(e)||this.observers.set(e,[]);const s=this.observers.get(e);s==null||s.push(t)}notify(e){const t=this.observers.get(e.type);if(t)for(const s of t)s.update(e)}}class Dt{constructor(){r(this,"name",c.STORAGE);r(this,"prefix",ye);r(this,"validator",d.getInstance().getService(c.VALIDATOR))}save(e,t){const s=this.prefix+e;globalThis.sessionStorage.setItem(s,JSON.stringify(t))}load(e,t){const s=this.prefix+e,n=globalThis.sessionStorage.getItem(s);if(!n)return null;try{const o=JSON.parse(n);return this.validator.validate(t,o)?o:null}catch{return null}}remove(e){const t=this.prefix+e;globalThis.sessionStorage.removeItem(t)}}class U{constructor(){r(this,"name",c.VALIDATOR);r(this,"privateTypes",{object:l.object,string:l.string,number:l.number,boolean:l.boolean});r(this,"typesConfig",{[l.object]:this.isObject.bind(this),[l.string]:this.isString.bind(this),[l.number]:this.isNumber.bind(this),[l.boolean]:this.isBoolean.bind(this),[l.authData]:this.isAuthData.bind(this),[l.usersPayload]:this.isUsersPayload.bind(this),[l.userPayload]:this.isUserPayload.bind(this),[l.message]:this.isMessage.bind(this),[l.messagePayload]:this.isMessagePayload.bind(this),[l.messagesPayload]:this.isMessagesPayload.bind(this),[l.isReadedStatusPayload]:this.isReadedStatusPayload.bind(this),[l.isDeliveredStatusPayload]:this.isDeliveredStatusPayload.bind(this),[l.isEditedStatusPayload]:this.isEditedStatusPayload.bind(this),[l.isDeletedStatusPayload]:this.isDeletedStatusPayload.bind(this)})}static isArrayOf(e,t){return Array.isArray(e)&&e.every(s=>t(s))}validate(e,t){return this.typesConfig[e](t)}isObject(e){return typeof e===this.privateTypes.object&&e!==null}isString(e){return typeof e===this.privateTypes.string}isNumber(e){return typeof e===this.privateTypes.number}isBoolean(e){return typeof e===this.privateTypes.boolean}isPositiveNumber(e){return this.isNumber(e)&&e>=B}isAuthData(e){return this.isObject(e)&&"login"in e&&"password"in e?this.isString(e.login)&&this.isString(e.password):!1}isUserData(e){return this.isObject(e)&&"login"in e&&"isLogined"in e?this.isString(e.login)&&this.isBoolean(e.isLogined):!1}isUserPayload(e){return this.isObject(e)&&"user"in e?this.isUserData(e.user):!1}isUsersPayload(e){return this.isObject(e)&&"users"in e?U.isArrayOf(e.users,this.isUserData.bind(this)):!1}isMessage(e){return this.isObject(e)&&"id"in e&&"from"in e&&"to"in e&&"text"in e&&"datetime"in e&&"status"in e?[e.id,e.from,e.to,e.text].every(this.isString.bind(this))&&this.isPositiveNumber(e.datetime)&&this.isMessageStatus(e.status):!1}isReadedStatusPayload(e){return this.isStatusPayload(e)&&this.isReadedStatus(e.status)}isDeliveredStatusPayload(e){return this.isStatusPayload(e)&&this.isDeliveredStatus(e.status)}isDeletedStatusPayload(e){return this.isStatusPayload(e)&&this.isDeletedStatus(e.status)}isEditedStatusPayload(e){return this.isStatusPayload(e)&&this.isEditedStatus(e.status)&&"text"in e&&this.isString(e.text)}isStatusPayload(e){return!(this.isObject(e)&&"message"in e)||!(this.isObject(e.message)&&"status"in e.message)?!1:this.isMessageStatus(e.message.status)}isMessageStatus(e){return this.isReadedStatus(e)&&this.isDeliveredStatus(e)&&this.isEditedStatus(e)}isReadedStatus(e){return this.isObject(e)&&"isReaded"in e?this.isBoolean(e.isReaded):!1}isDeletedStatus(e){return this.isObject(e)&&"isDeleted"in e?this.isBoolean(e.isDeleted):!1}isDeliveredStatus(e){return this.isObject(e)&&"isDelivered"in e?this.isBoolean(e.isDelivered):!1}isEditedStatus(e){return this.isObject(e)&&"isEdited"in e?this.isBoolean(e.isEdited):!1}isMessagePayload(e){return this.isObject(e)&&"message"in e?this.isMessage(e.message):!1}isMessagesPayload(e){return this.isObject(e)&&"messages"in e?U.isArrayOf(e.messages,this.isMessage.bind(this)):!1}}const Ot="ws://localhost:4000",bt=2e3,wt="_modal_1cjn7_1",Mt="_wrapper_1cjn7_17",Lt="_spinner_1cjn7_57",G={modal:wt,wrapper:Mt,spinner:Lt};class J extends E{constructor(){super();r(this,"modalWrapper");this.modalWrapper=this.addWrapper(),this.element.addEventListener("close",()=>{this.element.remove()})}showModal(t){document.body.append(this.element);try{t&&this.addContent(t),this.element.showModal()}catch(s){tt(s)}}createElement(){const t=this.createDOMElement({tagName:"dialog",classList:[G.modal]});return t.addEventListener("click",s=>{s.target===s.currentTarget&&this.element.close()}),t}addWrapper(){const t=this.createDOMElement({tagName:"div",classList:[G.wrapper,a.flex,a.flexColumn,a.alignCenter,a.gap20]});return this.element.append(t),t}}class _t extends J{constructor(){super();r(this,"isLoading",!1);this.addContent(),this.element.addEventListener("cancel",t=>{t.preventDefault(),console.log("cancel")}),document.addEventListener("keydown",t=>{this.blockEscap(t)})}addContent(){const t=this.createDOMElement({tagName:"p",textContent:"Connecting to the server"}),s=this.createDOMElement({tagName:"div",classList:[G.spinner]});this.modalWrapper.append(t,s)}showModal(){this.isLoading||(super.showModal(),this.isLoading=!0)}close(){this.element.close(),this.element.remove(),this.isLoading=!1}createElement(){return this.createDOMElement({tagName:"dialog",classList:[G.modal]})}blockEscap(t){t.key==="Escape"&&this.isLoading&&(t.stopPropagation(),t.preventDefault())}}class At{constructor(){r(this,"name",c.WEBSOCKET);r(this,"socket");r(this,"responseActions",new Map);r(this,"diContainer",d.getInstance());r(this,"url",Ot);r(this,"reconnectModal",new _t);this.socket=new WebSocket(this.url),this.connect()}requestToServer(e,t,s){const n=globalThis.crypto.randomUUID();s&&this.responseActions.set(n,s),this.send(n,e,t)}requestFromServer(e,t){const s=this.responseActions.get(e);s&&Array.isArray(s)?s.push(t):this.responseActions.set(e,[t])}connect(){this.socket.readyState===WebSocket.CLOSED&&(this.socket=new WebSocket(this.url),this.reconnectModal.showModal()),this.socket.addEventListener("open",()=>{this.diContainer.getService(c.EVENT_EMITTER).notify({type:R.openSocket}),this.reconnectModal.close()}),this.socket.addEventListener("close",()=>{setTimeout(()=>{this.connect()},bt)}),this.socket.addEventListener("message",e=>{this.onMessage(e)})}send(e,t,s){if(this.socket.readyState!==WebSocket.OPEN)return;const n={id:e,type:t,payload:s};this.socket.send(JSON.stringify(n))}onMessage(e){const t=JSON.parse(e.data);let s;s=t.id||t.type;let n=this.responseActions.get(s);if(Array.isArray(n)){for(const o of n)o.action(t.payload);return}t.type===u.ERROR&&(n!=null&&n.error)?n.error(t.payload.error):n==null||n.action(t.payload)}}class Tt extends J{constructor(){super()}addContent(e){this.modalWrapper.replaceChildren();const t=this.createDOMElement({tagName:"p",textContent:e});this.modalWrapper.append(t)}}class Rt{constructor(){r(this,"name",c.USER_SERVICE);r(this,"websocketService",d.getInstance().getService(c.WEBSOCKET));r(this,"storeController",L.getInstance());r(this,"router",d.getInstance().getService(c.ROUTER));r(this,"modal");d.getInstance().getService(c.EVENT_EMITTER).subscribe(R.openSocket,this),this.modal=new Tt}login(e){if(e=e||this.storeController.getState(p.USER),!e){this.router.navigateTo(m.LOGIN);return}const t={user:e};this.websocketService.requestToServer(u.LOGIN,t,{action:()=>{e&&this.storeController.dispatch({type:p.USER,payload:e}),this.router.navigateTo(m.MAIN)},error:s=>{this.modal.showModal(s)}})}logout(){const t={user:this.storeController.getState(p.USER)};this.websocketService.requestToServer(u.LOGOUT,t),this.storeController.dispatch({type:p.USER,payload:null}),this.router.navigateTo(m.LOGIN)}update(){this.login()}}const w={READ:"READ",DELETE:"DELETE",EDIT:"EDIT",DELIVER:"DELIVER"};class Ct{constructor(){r(this,"name",c.MESSAGE_SERVICE);r(this,"historyStore",T.getInstance());r(this,"countStore",x.getInstance());r(this,"websocketService");r(this,"validator");r(this,"messageSubscriptionsConfig",{[w.READ]:{type:u.READ,config:{validator:l.isReadedStatusPayload,actionType:h.READED_MESSAGE}},[w.DELIVER]:{type:u.DELIVER,config:{validator:l.isDeliveredStatusPayload,actionType:h.DELIVER_MESSAGE}},[w.DELETE]:{type:u.DELETE,config:{validator:l.isDeletedStatusPayload,actionType:h.DELETE_MESSAGE}},[w.EDIT]:{type:u.EDIT,config:{validator:l.isEditedStatusPayload,actionType:h.EDIT_MESSAGE}}});const e=d.getInstance();this.websocketService=e.getService(c.WEBSOCKET),this.validator=e.getService(c.VALIDATOR),this.subscribeToMessages()}sendMessage(e,t){const s={message:{to:t,text:e}};this.websocketService.requestToServer(u.MESSAGE,s,{action:this.sendMessageHandler.bind(this),error:n=>console.error(n)})}getMessagesHistory(e,t){this.historyStore.dispatch({type:h.CLEAR_DIALOG,payload:[]});const s={user:{login:e}};this.websocketService.requestToServer(u.HISTORY,s,{action:n=>{this.validator.validate(l.messagesPayload,n)&&(this.historyStore.dispatch({type:h.SET_MESSAGES,payload:n.messages}),t(n.messages))},error:n=>console.error(n)})}changeMessageStatus(e,t,s){var g;const n={message:{id:e}},o=(g=this.historyStore.getState(f.DIALOG_ID))==null?void 0:g.login;o&&t===w.READ&&this.countStore.dispatch({type:o,payload:B}),this.websocketService.requestToServer(u[t],n,{action:S=>{this.validator.validate(l.messagePayload,S)&&s&&s(S.message)},error:S=>console.error(S)})}setNewMessagesCount(e){this.getMessagesHistory(e,t=>{const s=t.filter(n=>!n.status.isReaded&&n.from===e);this.countStore.dispatch({type:e,payload:s.length})})}sendMessageHandler(e){this.validator.validate(l.messagePayload,e)&&this.historyStore.dispatch({type:h.ADD_MESSAGE,payload:[e.message.id,e.message]})}newMessageHandler(e){var s;if(!this.validator.validate(l.messagePayload,e))return;const t=(s=this.historyStore.getState(f.DIALOG_ID))==null?void 0:s.login;if(e.message.from===t)this.historyStore.dispatch({type:h.ADD_MESSAGE,payload:[e.message.id,e.message]}),this.changeMessageStatus(e.message.id,w.READ);else{const n=e.message.from,o=this.countStore.getState();o[n]?this.countStore.dispatch({type:n,payload:o[n]+C}):this.countStore.dispatch({type:n,payload:C})}}subscribeToMessages(){this.websocketService.requestFromServer(u.MESSAGE,{action:this.newMessageHandler.bind(this)});for(const{type:e,...t}of Object.values(this.messageSubscriptionsConfig))this.websocketService.requestFromServer(e,{action:s=>this.changeStatusHandler(s,t.config)})}changeStatusHandler(e,{validator:t,actionType:s}){if(!(!this.validator.validate(t,e)||!this.historyStore.getState(f.MESSAGES).has(e.message.id))){if(s===h.DELETE_MESSAGE){this.historyStore.dispatch({type:h.DELETE_MESSAGE,payload:e.message.id});return}if(s===h.EDIT_MESSAGE){this.historyStore.dispatch({type:h.EDIT_MESSAGE,payload:{message:{id:e.message.id,status:e.message.status,text:"text"in e.message?e.message.text:M}}});return}this.historyStore.dispatch({type:s,payload:e})}}}function Nt(){const i=d.getInstance();i.register(c.ROUTER,It),i.register(c.EVENT_EMITTER,yt),i.register(c.STORAGE,Dt),i.register(c.VALIDATOR,U),i.register(c.WEBSOCKET,At),i.register(c.USER_SERVICE,Rt),i.register(c.MESSAGE_SERVICE,Ct)}function xt(){Nt();const i=document.body,e=new xe().addSettingsButton(j.THEME).getElement(),t=document.createElement("main");i.append(e,t),d.getInstance().getService(c.ROUTER).setContainer(t).addRoutes(vt)}xt();
//# sourceMappingURL=main-PjT79t3K.js.map
